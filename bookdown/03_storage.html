<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3 Exchanging and storing tokens | _main.utf8.md</title>
  <meta name="description" content="" />
  <meta name="generator" content="bookdown 0.11.1 and GitBook 2.6.7" />

  <meta property="og:title" content="3 Exchanging and storing tokens | _main.utf8.md" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3 Exchanging and storing tokens | _main.utf8.md" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="02_auth_strategies.html">
<link rel="next" href="04_security.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#what-is-sealr"><i class="fa fa-check"></i><b>1.1</b> What is sealr?</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#what-are-authentication-and-authorization"><i class="fa fa-check"></i><b>1.2</b> What are authentication and authorization?</a><ul>
<li class="chapter" data-level="1.2.1" data-path="index.html"><a href="index.html#authenticating-users"><i class="fa fa-check"></i><b>1.2.1</b> Authenticating users</a></li>
<li class="chapter" data-level="1.2.2" data-path="index.html"><a href="index.html#authorizing-users"><i class="fa fa-check"></i><b>1.2.2</b> Authorizing users</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#implementation"><i class="fa fa-check"></i><b>1.3</b> Implementation</a><ul>
<li class="chapter" data-level="1.3.1" data-path="index.html"><a href="index.html#overview"><i class="fa fa-check"></i><b>1.3.1</b> Overview</a></li>
<li class="chapter" data-level="1.3.2" data-path="index.html"><a href="index.html#authenticate"><i class="fa fa-check"></i><b>1.3.2</b> authenticate</a></li>
<li class="chapter" data-level="1.3.3" data-path="index.html"><a href="index.html#is_authed-functions"><i class="fa fa-check"></i><b>1.3.3</b> is_authed functions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="02_auth_strategies.html"><a href="02_auth_strategies.html"><i class="fa fa-check"></i><b>2</b> Strategies</a><ul>
<li class="chapter" data-level="2.1" data-path="02_auth_strategies.html"><a href="02_auth_strategies.html#json-web-tokens-jwt"><i class="fa fa-check"></i><b>2.1</b> JSON Web Tokens (JWT)</a><ul>
<li class="chapter" data-level="2.1.1" data-path="02_auth_strategies.html"><a href="02_auth_strategies.html#introduction-1"><i class="fa fa-check"></i><b>2.1.1</b> Introduction</a></li>
<li class="chapter" data-level="2.1.2" data-path="02_auth_strategies.html"><a href="02_auth_strategies.html#simple-example"><i class="fa fa-check"></i><b>2.1.2</b> Simple Example</a></li>
<li class="chapter" data-level="2.1.3" data-path="02_auth_strategies.html"><a href="02_auth_strategies.html#claims-example"><i class="fa fa-check"></i><b>2.1.3</b> Claims Example</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="02_auth_strategies.html"><a href="02_auth_strategies.html#open-id-connect---google"><i class="fa fa-check"></i><b>2.2</b> Open ID Connect - Google</a><ul>
<li class="chapter" data-level="2.2.1" data-path="02_auth_strategies.html"><a href="02_auth_strategies.html#introduction-2"><i class="fa fa-check"></i><b>2.2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2.2" data-path="02_auth_strategies.html"><a href="02_auth_strategies.html#example"><i class="fa fa-check"></i><b>2.2.2</b> Example</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="03_storage.html"><a href="03_storage.html"><i class="fa fa-check"></i><b>3</b> Exchanging and storing tokens</a><ul>
<li class="chapter" data-level="3.1" data-path="03_storage.html"><a href="03_storage.html#exchanging-tokens"><i class="fa fa-check"></i><b>3.1</b> Exchanging tokens</a><ul>
<li class="chapter" data-level="3.1.1" data-path="03_storage.html"><a href="03_storage.html#issueing-the-token"><i class="fa fa-check"></i><b>3.1.1</b> Issueing the token</a></li>
<li class="chapter" data-level="3.1.2" data-path="03_storage.html"><a href="03_storage.html#cookie"><i class="fa fa-check"></i><b>3.1.2</b> Cookie</a></li>
<li class="chapter" data-level="3.1.3" data-path="03_storage.html"><a href="03_storage.html#http-authorization-header"><i class="fa fa-check"></i><b>3.1.3</b> HTTP Authorization header</a></li>
<li class="chapter" data-level="3.1.4" data-path="03_storage.html"><a href="03_storage.html#interactive-r-session"><i class="fa fa-check"></i><b>3.1.4</b> Interactive R session</a></li>
<li class="chapter" data-level="3.1.5" data-path="03_storage.html"><a href="03_storage.html#another-application"><i class="fa fa-check"></i><b>3.1.5</b> Another application</a></li>
<li class="chapter" data-level="3.1.6" data-path="03_storage.html"><a href="03_storage.html#web-application"><i class="fa fa-check"></i><b>3.1.6</b> Web application</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="03_storage.html"><a href="03_storage.html#local-storage"><i class="fa fa-check"></i><b>3.2</b> Local Storage</a></li>
<li class="chapter" data-level="3.3" data-path="03_storage.html"><a href="03_storage.html#cookie-1"><i class="fa fa-check"></i><b>3.3</b> Cookie</a><ul>
<li class="chapter" data-level="3.3.1" data-path="03_storage.html"><a href="03_storage.html#cookie-example"><i class="fa fa-check"></i><b>3.3.1</b> Cookie example</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="04_security.html"><a href="04_security.html"><i class="fa fa-check"></i><b>4</b> Security</a><ul>
<li class="chapter" data-level="4.1" data-path="04_security.html"><a href="04_security.html#https"><i class="fa fa-check"></i><b>4.1</b> HTTPS</a></li>
<li class="chapter" data-level="4.2" data-path="04_security.html"><a href="04_security.html#cookies-and-csrf"><i class="fa fa-check"></i><b>4.2</b> Cookies and CSRF</a></li>
<li class="chapter" data-level="4.3" data-path="04_security.html"><a href="04_security.html#local-storage-and-xss"><i class="fa fa-check"></i><b>4.3</b> Local storage and XSS</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="exchanging-and-storing-tokens" class="section level1">
<h1><span class="header-section-number">3</span> Exchanging and storing tokens</h1>
<p>The token you provide to the user needs to be stored on their machine so that
they can later send it back in the request to your plumber API. Where and how
the token is stored depends on your use case and what the service making the requests to your API looks like.</p>
<div id="exchanging-tokens" class="section level2">
<h2><span class="header-section-number">3.1</span> Exchanging tokens</h2>
<div id="issueing-the-token" class="section level3">
<h3><span class="header-section-number">3.1.1</span> Issueing the token</h3>
<p>When you first issue a token to the user - i.e. in the <code>authentication</code> endpoint of our examples - , you have two options how you want to return it to them: send it as part of the HTTP response or set a token in the browser of the user.</p>
<div id="return-in-http-response" class="section level4">
<h4><span class="header-section-number">3.1.1.1</span> Return in HTTP response</h4>
<p>Return the token in the HTTP response by including the appropriate <code>return</code> statement at the end of your <code>authentication</code> endpoint.</p>
<pre class="sourceCode r"><code class="sourceCode r">pr<span class="op">$</span><span class="kw">handle</span>(<span class="st">&quot;POST&quot;</span>, <span class="st">&quot;/authentication&quot;</span>, <span class="cf">function</span> (req, res, <span class="dt">user =</span> <span class="ot">NULL</span>, <span class="dt">password =</span> <span class="ot">NULL</span>) {

  <span class="co"># ... </span>
  <span class="co"># CODE HERE</span>
  <span class="co"># ...</span>
  
  <span class="co"># return jwt as response</span>
  <span class="kw">return</span>(<span class="dt">jwt =</span> jwt)
}, <span class="dt">preempt =</span> <span class="kw">c</span>(<span class="st">&quot;sealr-jwt&quot;</span>))</code></pre>
<p>This is the most flexible way as it allows the user to handle the token according to their needs. They could…</p>
<ul>
<li>… store the token somewhere and later include it in an R script or R Markdown. For example, if the user wants to generate reports and needs to use your API in order to do this. They should take care to follow <a href="https://db.rstudio.com/best-practices/managing-credentials/">guidelines</a> on how to securely manage credentials and never include the token in their scripts.</li>
<li>… store the token in their web browser’s local storage. The local storage of a web browser is. This is relevant if the user makes the request from a web application from their browser (see . The implementation of the storing mechanism would be part of the frontend code. All frontend oriented languages support storing</li>
</ul>
</div>
</div>
<div id="cookie" class="section level3">
<h3><span class="header-section-number">3.1.2</span> Cookie</h3>
</div>
<div id="http-authorization-header" class="section level3">
<h3><span class="header-section-number">3.1.3</span> HTTP Authorization header</h3>
</div>
<div id="interactive-r-session" class="section level3">
<h3><span class="header-section-number">3.1.4</span> Interactive R session</h3>
<p>If your users simply use the token to make requests from an R script, e.g. by executing an <code>.R</code> file or generating
an R markdown file, they should store their token in a secure way.</p>
<p>Some resources to get started:
- <a href="https://db.rstudio.com/best-practices/managing-credentials/">https://db.rstudio.com/best-practices/managing-credentials/</a></p>
</div>
<div id="another-application" class="section level3">
<h3><span class="header-section-number">3.1.5</span> Another application</h3>
<p>Another service</p>
</div>
<div id="web-application" class="section level3">
<h3><span class="header-section-number">3.1.6</span> Web application</h3>
<p>Finally, you could have a “typical” web frontend-backend infrastructure where you
want to use plumber to serve data to a frontend that your user can visit in their
Internet browser.</p>
<p>Typically, in web development, there are two approaches to storing user data.</p>
</div>
</div>
<div id="local-storage" class="section level2">
<h2><span class="header-section-number">3.2</span> Local Storage</h2>
</div>
<div id="cookie-1" class="section level2">
<h2><span class="header-section-number">3.3</span> Cookie</h2>
<p>Instead of requiring the user to send the JWT back in the HTTP Authorization header,
you can also use a cookie in the browser of the API user to store the
JWT. This way, the user does not have to remember to send the JWT in the
Authorization header.</p>
<p>Instead of requiring the user to send the JWT back in the HTTP Authorization header,
you can also use a cookie in the browser of the API user to store the
JWT. This way, the user does not have to remember to send the JWT in the
Authorization header.</p>
<div id="cookie-example" class="section level3">
<h3><span class="header-section-number">3.3.1</span> Cookie example</h3>
<p>In this example, we use an encrypted cookie to store the JWT. You can find the
full code for this example at the <a href="#code">end of this page</a>.
In order to do this, we register an encrypted session cookie (<a href="https://www.rplumber.io/docs/rendering-and-output.html#encrypted-cookies">see plumber docs</a>):</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># define a new plumber router</span>
pr &lt;-<span class="st"> </span>plumber<span class="op">::</span>plumber<span class="op">$</span><span class="kw">new</span>()
<span class="co"># register cookie</span>
pr<span class="op">$</span><span class="kw">registerHooks</span>(plumber<span class="op">::</span><span class="kw">sessionCookie</span>(<span class="dt">key =</span> <span class="st">&quot;EPCGoaMO9dIxIEPoOjOL4sjL4U6w0GQ5&quot;</span>, <span class="dt">name =</span> <span class="st">&quot;token&quot;</span>))</code></pre>
<p>In the <code>authentication</code> route, we then can set the JWT in the cookie.
Note that we do not return the JWT to the user because the JWT will be transferred in the cookie instead.</p>
<pre class="sourceCode r"><code class="sourceCode r">pr<span class="op">$</span><span class="kw">handle</span>(<span class="st">&quot;POST&quot;</span>, <span class="st">&quot;/authentication&quot;</span>, <span class="cf">function</span> (req, res, <span class="dt">user =</span> <span class="ot">NULL</span>, <span class="dt">password =</span> <span class="ot">NULL</span>) {
  <span class="co"># ...</span>
  <span class="co"># ...</span>
  <span class="co"># set cookie</span>
  req<span class="op">$</span>session<span class="op">$</span>token &lt;-<span class="st"> </span>jwt
  <span class="kw">return</span>()
})</code></pre>
<p>The filter looks the same as in the simple example except that we have to change the <code>token_location</code> parameter to <code>"cookie"</code> instead of <code>"header"</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># integrate the jwt strategy in a filter</span>
pr<span class="op">$</span><span class="kw">filter</span>(<span class="st">&quot;sealr-jwt&quot;</span>, <span class="cf">function</span> (req, res) {
  <span class="co"># simply call the strategy and forward the request and response</span>
  <span class="co"># please change the secret</span>
  sealr<span class="op">::</span><span class="kw">authenticate</span>(<span class="dt">req =</span> req, <span class="dt">res =</span> res, <span class="dt">is_authed_fun =</span> sealr<span class="op">::</span>is_authed_jwt,
                      <span class="dt">token_location =</span> <span class="st">&quot;cookie&quot;</span>, <span class="dt">secret =</span> secret)
})</code></pre>
<p>:warning: Please change the secret to a super secure secret of your choice. Please notice that you have to <code>preempt = c("sealr-jwt")</code> to routes that should <strong>not</strong> be protected.</p>
<p><strong>Run the example</strong></p>
<p>Copy the code from <a href="#code">below</a> in a new R file and
save it under <code>jwt_cookie_example.R</code>. In the R console, run:</p>
<pre class="sourceCode r"><code class="sourceCode r">plumber<span class="op">::</span><span class="kw">plumb</span>(<span class="st">&quot;jwt_cookie_example.R&quot;</span>)</code></pre>
<p>In order to run this example, you need the following packages installed:</p>
<ul>
<li>sealr</li>
<li>plumber</li>
<li>httr</li>
<li>jose</li>
<li>jsonlite</li>
</ul>
<p><strong>Get authentication</strong></p>
<p>Using curl, Postman or a similar tool for sending HTTP requests, send a POST request with the details of one of the two users that are in the API’s “database” (in this simplified example, a data frame).</p>
<table>
<colgroup>
<col width="3%" />
<col width="20%" />
<col width="75%" />
</colgroup>
<thead>
<tr class="header">
<th align="right">id</th>
<th align="left">user</th>
<th align="left">password</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left"><a href="mailto:jane@example.com" class="email">jane@example.com</a></td>
<td align="left">$2a<span class="math inline">\(12\)</span>zpd7xktqLvW0sDknZ9O4ReSeT0VA6kSMfa.3UlUpMTenfrsURMF7q</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left"><a href="mailto:bob@example.com" class="email">bob@example.com</a></td>
<td align="left">$2a<span class="math inline">\(12\)</span>/9D7BQMokkW9bXUgsKl/wueF8jDfxo2Zd6d.2RZ/6ybmohPom6w4q</td>
</tr>
</tbody>
</table>
<p>For example, in curl:</p>
<p><strong>Note</strong>: You might get different encrypted JWTs in your <code>cookies_jane.txt</code> as <code>jose::jwt_encode_hmac</code> automatically adds the time when the JWT was issued as a claim (<code>iat</code> claim).</p>
<pre><code>curl  --cookie-jar cookies_jane.txt --data &#39;{&quot;user&quot;: &quot;jane@example.com&quot;, &quot;password&quot;: &quot;12345&quot;}&#39; localhost:9090/authentication</code></pre>
<p>The <code>--cookie-jar</code> argument will store the cookie in a plain-text file in your current directory called <code>cookies_jane.txt</code>.</p>
<p>If you inspect this file (e.g. using <code>cat cookies_jane.txt</code>), you should see something like this:</p>
<pre><code># Netscape HTTP Cookie File
# https://curl.haxx.se/docs/http-cookies.html
# This file was generated by libcurl! Edit at your own risk.

localhost   FALSE   /   FALSE   0   token   R/cOKStnaCrwojcbL4Uk1602scv7ln9PClDYO2LlfHd0zYtd+vYrGB6oTX7wvpp5hmipFxqnQ0FDwEdz1H7IjCr6KCxxUHnpWu8r0IjCA4zLHbJz/i5npGe16Ei+OhbOGbluT/An+0GnfzXsna4q4vHoB2P+GkUPZL3Xe7tZxIX+UHSk005tX89NcSLpVy6J</code></pre>
<p>The token is the gibberish part at the end. It is indeed the JWT but it is encrypted and hence does not <em>look</em> like a JWT.</p>
<p>Trying to get a token cookie for a user that is not in the database of course fails:</p>
<pre><code>curl --cookie-jar cookies_drake.txt --data &#39;{&quot;user&quot;: &quot;drake@example.com&quot;, &quot;password&quot;: &quot;10111213&quot;}&#39; localhost:9090/authentication</code></pre>
<pre><code>{&quot;status&quot;:[&quot;Failed.&quot;],&quot;code&quot;:[401],&quot;message&quot;:[&quot;User or password wrong.&quot;]}</code></pre>
<p><strong>Route without required authentication</strong></p>
<p>Everyone can access the <code>/</code> route because it does not require authentication - the <code>sealr-jwt</code> filter is <code>preempt</code>ed for this route:</p>
<pre><code>curl localhost:9090
[&quot;Access to route without authentication was successful.&quot;]</code></pre>
<p><strong>Route with required authentication</strong></p>
<p>Trying to access the <code>/secret</code> route without a valid cookie fails because it goes through the <code>sealr-jwt</code> filter where the <code>sealr::jwt</code> function will check for the correct authentication details - in this case a valid JWT in <code>token</code> cookie.</p>
<pre><code>curl localhost:9090/secret</code></pre>
<pre><code>{&quot;status&quot;:[&quot;Failed.&quot;],&quot;code&quot;:[401],&quot;message&quot;:[&quot;Authentication required.&quot;]}</code></pre>
<p>But if you add the cookies for Jane to the request, authentication is successful.</p>
<pre><code>curl --cookie cookies_jane.txt localhost:9090/secret</code></pre>
<pre><code>[&quot;Access to route requiring authentication was successful.&quot;]</code></pre>
<p><strong>Code</strong> {code}</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># define a user database</span>
<span class="co"># you should probably use a SQL database instead of data frames</span>
users &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">id       =</span> <span class="kw">integer</span>(),
                    <span class="dt">name     =</span> <span class="kw">character</span>(),
                    <span class="dt">password =</span> <span class="kw">character</span>(),
                    <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)

<span class="co"># create test user</span>
users &lt;-<span class="st"> </span><span class="kw">rbind</span>(users, <span class="kw">data.frame</span>(<span class="dt">id       =</span> <span class="dv">1</span>,
                                 <span class="dt">user     =</span> <span class="st">&quot;jane@example.com&quot;</span>,
                                 <span class="dt">password =</span> bcrypt<span class="op">::</span><span class="kw">hashpw</span>(<span class="st">&quot;12345&quot;</span>),
                                 <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>))
users &lt;-<span class="st"> </span><span class="kw">rbind</span>(users, <span class="kw">data.frame</span>(<span class="dt">id       =</span> <span class="dv">2</span>,
                                 <span class="dt">user     =</span> <span class="st">&quot;bob@example.com&quot;</span>,
                                 <span class="dt">password =</span> bcrypt<span class="op">::</span><span class="kw">hashpw</span>(<span class="st">&quot;45678&quot;</span>),
                                 <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>))

<span class="co"># define a new plumber router</span>
pr &lt;-<span class="st"> </span>plumber<span class="op">::</span>plumber<span class="op">$</span><span class="kw">new</span>()
<span class="co"># register cookie</span>
pr<span class="op">$</span><span class="kw">registerHooks</span>(plumber<span class="op">::</span><span class="kw">sessionCookie</span>(<span class="dt">key =</span> <span class="st">&quot;EPCGoaMO9dIxIEPoOjOL4sjL4U6w0GQ5&quot;</span>, <span class="dt">name =</span> <span class="st">&quot;token&quot;</span>))

<span class="co"># define your super secret for hmac</span>
secret &lt;-<span class="st"> &quot;3ec9aaf4a744f833e98c954365892583&quot;</span>

<span class="co"># integrate the jwt strategy in a filter</span>
pr<span class="op">$</span><span class="kw">filter</span>(<span class="st">&quot;sealr-jwt&quot;</span>, <span class="cf">function</span> (req, res) {
  <span class="co"># simply call the strategy and forward the request and response</span>
  sealr<span class="op">::</span><span class="kw">authenticate</span>(<span class="dt">req =</span> req, <span class="dt">res =</span> res, <span class="dt">is_authed_fun =</span> sealr<span class="op">::</span>is_authed_jwt,
                      <span class="dt">token_location =</span> <span class="st">&quot;cookie&quot;</span>, <span class="dt">secret =</span> secret)
})

<span class="co"># define authentication route to issue web tokens (exclude &quot;sealr-jwt&quot; filter using preempt)</span>
pr<span class="op">$</span><span class="kw">handle</span>(<span class="st">&quot;POST&quot;</span>, <span class="st">&quot;/authentication&quot;</span>, <span class="cf">function</span> (req, res, <span class="dt">user =</span> <span class="ot">NULL</span>, <span class="dt">password =</span> <span class="ot">NULL</span>) {

  <span class="co"># check if user provided credentials</span>
  <span class="cf">if</span> (<span class="kw">is.null</span>(user) <span class="op">||</span><span class="st"> </span><span class="kw">is.null</span>(password)) {
    res<span class="op">$</span>status &lt;-<span class="st"> </span><span class="dv">404</span>
    <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">status=</span><span class="st">&quot;Failed.&quot;</span>,
                <span class="dt">code=</span><span class="dv">404</span>,
                <span class="dt">message=</span><span class="st">&quot;Please return password or username.&quot;</span>))
  }

  <span class="co"># find user in database</span>
  index &lt;-<span class="st"> </span><span class="kw">match</span>(user, users<span class="op">$</span>user)

  <span class="co"># check if user exist</span>
  <span class="cf">if</span> (<span class="kw">is.na</span>(index)) {
    res<span class="op">$</span>status &lt;-<span class="st"> </span><span class="dv">401</span>
    <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">status=</span><span class="st">&quot;Failed.&quot;</span>,
                <span class="dt">code=</span><span class="dv">401</span>,
                <span class="dt">message=</span><span class="st">&quot;User or password wrong.&quot;</span>))
  }

  <span class="co"># check if password is correct</span>
  <span class="cf">if</span> (<span class="op">!</span>bcrypt<span class="op">::</span><span class="kw">checkpw</span>(password, users<span class="op">$</span>password[index])){
    res<span class="op">$</span>status &lt;-<span class="st"> </span><span class="dv">401</span>
    <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">status=</span><span class="st">&quot;Failed.&quot;</span>,
                <span class="dt">code=</span><span class="dv">401</span>,
                <span class="dt">message=</span><span class="st">&quot;User or password wrong.&quot;</span>))
  }

  <span class="co"># define jwt payload</span>
  <span class="co"># information about the additional fields can be found at</span>
  <span class="co"># https://tools.ietf.org/html/rfc7519#section-4.1</span>
  payload &lt;-<span class="st"> </span>jose<span class="op">::</span><span class="kw">jwt_claim</span>(<span class="dt">userID =</span> users<span class="op">$</span>id[index])

  <span class="co"># convert secret to bytes</span>
  secret_raw &lt;-<span class="st"> </span><span class="kw">charToRaw</span>(secret)

  <span class="co"># encode token using the secret</span>
  jwt &lt;-<span class="st"> </span>jose<span class="op">::</span><span class="kw">jwt_encode_hmac</span>(payload, <span class="dt">secret =</span> secret_raw)

  <span class="co"># set cookie</span>
  req<span class="op">$</span>session<span class="op">$</span>token &lt;-<span class="st"> </span>jwt
  <span class="kw">return</span>()
}, <span class="dt">preempt =</span> <span class="kw">c</span>(<span class="st">&quot;sealr-jwt&quot;</span>))

<span class="co"># define test route without authentication  (exclude &quot;sealr-jwt&quot; filter using preempt)</span>
pr<span class="op">$</span><span class="kw">handle</span>(<span class="st">&quot;GET&quot;</span>, <span class="st">&quot;/&quot;</span>, <span class="cf">function</span> (req, res) {
  <span class="kw">return</span>(<span class="st">&quot;Access to route without authentication was successful.&quot;</span>)
}, <span class="dt">preempt =</span> <span class="kw">c</span>(<span class="st">&quot;sealr-jwt&quot;</span>))



<span class="co"># define test route with authentication</span>
pr<span class="op">$</span><span class="kw">handle</span>(<span class="st">&quot;GET&quot;</span>, <span class="st">&quot;/secret&quot;</span>, <span class="cf">function</span> (req, res) {
  <span class="kw">return</span>(<span class="st">&quot;Access to route requiring authentication was successful.&quot;</span>)
})

<span class="co"># start API server</span>
pr<span class="op">$</span><span class="kw">run</span>(<span class="dt">host =</span> <span class="st">&quot;0.0.0.0&quot;</span>, <span class="dt">port =</span> <span class="dv">9090</span>)</code></pre>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="02_auth_strategies.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="04_security.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
},
"toolbar": {
"position": "fixed"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
